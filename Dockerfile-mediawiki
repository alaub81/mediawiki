ARG MW_VERSION=1.43
FROM mediawiki:${MW_VERSION}
ENV DEBIAN_FRONTEND=noninteractive

ARG MW_VERSION=1.43
ENV MW_EXTENSIONS="Lockdown Description2 RelatedArticles MobileFrontend WikiCategoryTagCloud"
ENV MW_SKINS=""

COPY resources/mediawiki/mediawiki-rewrites.conf /etc/apache2/conf-available/mediawiki-rewrites.conf

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
      git \
      ca-certificates \
      curl \
      tzdata \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* \
  && a2enmod headers \
  && a2enconf mediawiki-rewrites

RUN set -eux; \
  BR="${MW_BRANCH:-REL${MW_VERSION%%.*}_${MW_VERSION#*.}}"; \
  echo "Using MW_BRANCH=$BR"; \
  clone_or_replace() { \
    url="$1"; target="$2"; branch="$3"; \
    rm -rf "$target"; \
    if git ls-remote --heads "$url" "$branch" >/dev/null 2>&1; then \
      git clone --depth=1 --single-branch -b "$branch" "$url" "$target"; \
    elif git ls-remote --heads "$url" master >/dev/null 2>&1; then \
      git clone --depth=1 --single-branch -b master "$url" "$target"; \
    elif git ls-remote --heads "$url" main >/dev/null 2>&1; then \
      git clone --depth=1 --single-branch -b main "$url" "$target"; \
    else \
      echo "No suitable branch in $url"; exit 128; \
    fi; \
  }; \
  for ext in $MW_EXTENSIONS; do \
    clone_or_replace "https://gerrit.wikimedia.org/r/mediawiki/extensions/$ext" "/var/www/html/extensions/$ext" "$BR"; \
  done; \
  for skin in $MW_SKINS; do \
    clone_or_replace "https://gerrit.wikimedia.org/r/mediawiki/skins/$skin" "/var/www/html/skins/$skin" "$BR"; \
  done; \
  # Sonderf√§lle
  rm -rf /var/www/html/extensions/RottenLinks; \
  clone_or_replace "https://github.com/miraheze/RottenLinks.git" "/var/www/html/extensions/RottenLinks" "$BR"; \
  cd /var/www/html/skins; \
  find /var/www/html/extensions -name .git -type d -prune -exec rm -rf {} +; \
  find /var/www/html/skins -name .git -type d -prune -exec rm -rf {} +; \
  chown -R www-data:www-data /var/www/html/extensions; \
  chown -R www-data:www-data /var/www/html/skins

# Supercronic (arch-agnostisch)
ARG TARGETARCH
RUN curl -fsSLo /usr/local/bin/supercronic \
  "https://github.com/aptible/supercronic/releases/download/v0.2.36/supercronic-linux-${TARGETARCH}" \
  && chmod +x /usr/local/bin/supercronic

COPY resources/mediawiki/mediawiki-entrypoint.sh /usr/local/bin/mediawiki-entrypoint.sh
COPY resources/mediawiki/generate-sitemap.sh    /usr/local/bin/generate-sitemap.sh
RUN chmod +x /usr/local/bin/mediawiki-entrypoint.sh /usr/local/bin/generate-sitemap.sh

ENTRYPOINT ["/usr/local/bin/mediawiki-entrypoint.sh"]
CMD ["apache2-foreground"]
