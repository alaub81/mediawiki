FROM mediawiki:1.43
ENV DEBIAN_FRONTEND=noninteractive

ENV MW_INSTALL_EXTENSIONS="Lockdown Description2 RelatedArticles MobileFrontend WikiCategoryTagCloud"
ENV MW_INSTALL_SKINS="DeskMessMirrored"

COPY resources/mediawiki/mediawiki-rewrites.conf /etc/apache2/conf-available/mediawiki-rewrites.conf

# RUN apt-get update \
#   && apt-get install -y --no-install-recommends \
#       git \
#       ca-certificates \
#       curl \
#       tzdata \
#   && apt-get clean \
#   && rm -rf /var/lib/apt/lists/* \
#   && a2enmod headers \
#   && a2enconf mediawiki-rewrites

RUN a2enmod headers \
  && a2enconf mediawiki-rewrites

RUN set -eux; \
  BR="${MW_BRANCH:-REL${MEDIAWIKI_MAJOR_VERSION%%.*}_${MEDIAWIKI_MAJOR_VERSION#*.}}"; \
  echo "Using MW_BRANCH=$BR"; \
  clone_or_replace() { \
    url="$1"; target="$2"; branch="$3"; \
    rm -rf "$target"; \
    if git ls-remote --heads "$url" "$branch" >/dev/null 2>&1; then \
      git clone --depth=1 --single-branch -b "$branch" "$url" "$target"; \
    elif git ls-remote --heads "$url" master >/dev/null 2>&1; then \
      git clone --depth=1 --single-branch -b master "$url" "$target"; \
    elif git ls-remote --heads "$url" main >/dev/null 2>&1; then \
      git clone --depth=1 --single-branch -b main "$url" "$target"; \
    else \
      echo "No suitable branch in $url"; exit 128; \
    fi; \
  }; \
  for ext in $MW_INSTALL_EXTENSIONS; do \
    clone_or_replace "https://gerrit.wikimedia.org/r/mediawiki/extensions/$ext" "/var/www/html/extensions/$ext" "$BR"; \
  done; \
  for skin in $MW_INSTALL_SKINS; do \
    clone_or_replace "https://gerrit.wikimedia.org/r/mediawiki/skins/$skin" "/var/www/html/skins/$skin" "$BR"; \
  done; \
  # Sonderfälle
  rm -rf /var/www/html/extensions/RottenLinks; \
  clone_or_replace "https://github.com/miraheze/RottenLinks.git" "/var/www/html/extensions/RottenLinks" "$BR"; \
  find /var/www/html/extensions -name .git -type d -prune -exec rm -rf {} +; \
  find /var/www/html/skins -name .git -type d -prune -exec rm -rf {} +; \
  chown -R www-data:www-data /var/www/html/extensions; \
  chown -R www-data:www-data /var/www/html/skins

# # im entrypoint
# add_to_list(){ printf '%s %s\n' "$1" "$2" | tr ' ' '\n' | awk 'NF && !seen[$0]++' | xargs; }
# : "${MW_EXTENSIONS:=}"
# : "${MW_SKINS:=}"
# # Beispiel: RottenLinks anfügen, wenn vorhanden
# # MW_EXTENSIONS="$(add_to_list "$MW_EXTENSIONS" 'RottenLinks')"
# export MW_EXTENSIONS MW_SKINS
ENV MW_EXTRA_EXTENSIONS="${MW_INSTALL_EXTENSIONS} RottenLinks"
ENV MW_EXTRA_SKINS="${MW_INSTALL_SKINS}"

# Supercronic (arch-agnostisch)
ARG TARGETARCH
RUN curl -fsSLo /usr/local/bin/supercronic \
  "https://github.com/aptible/supercronic/releases/download/v0.2.36/supercronic-linux-${TARGETARCH}" \
  && chmod +x /usr/local/bin/supercronic

COPY --chmod=0755 resources/mediawiki/mediawiki-entrypoint.sh /usr/local/bin/mediawiki-entrypoint.sh
COPY --chmod=0755 resources/mediawiki/generate-sitemap.sh /usr/local/bin/generate-sitemap.sh
COPY --chmod=0755 resources/mediawiki/generate-rottenlinks.sh /usr/local/bin/generate-rottenlinks.sh
COPY --chmod=0755 resources/mediawiki/mw-default-setup.sh /usr/local/bin/mw-default-setup.sh

ENTRYPOINT ["/usr/local/bin/mediawiki-entrypoint.sh"]
CMD ["apache2-foreground"]
